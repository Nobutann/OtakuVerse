{% extends 'base.html' %}
{% load static %}

{% block title %}{{ user.username }} - OtakuVerse{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'users/css/profile.css' %}">

<main class="profile-main">
    <div class="container">
        <div class="profile-header">
            <div class="profile-avatar">
                <img src="{{ user.profile.avatar.url }}" alt="Avatar de {{ user.username }}" class="avatar-image">
            </div>
            
            <div class="profile-info">
                <div class="profile-title">
                    <h1 class="username">{{ user.username }}</h1>
                    {% if user.profile.age %}
                        <span class="age">{{ user.profile.age }} anos</span>
                    {% endif %}
                </div>
                
                {% if user.profile.location %}
                    <div class="profile-location">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z"/>
                            <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/>
                        </svg>
                        <span>{{ user.profile.location }}</span>
                    </div>
                {% endif %}
                
                <div class="profile-meta">
                    <span class="joined-date">
                        Membro desde {{ user.profile.joinedDate|date:"M Y" }}
                    </span>
                    {% if user.profile.lastOnline %}
                        <span class="last-online">
                            Visto por último {{ user.profile.lastOnline|timesince }} atrás
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="profile-actions">
                {% if request.user == user %}
                    <a href="{% url 'users:edit_profile' %}" class="btn btn-primary">
                        <!-- Ícone de edição -->
                        Editar Perfil
                    </a>
                {% else %}
                    {% if friendship_status == 'friends' %}
                        <a href="{% url 'users:remove_friend' user.username %}" class="btn btn-secondary">
                            Remover Amizade
                        </a>
                    {% elif friendship_status == 'request_sent' %}
                        <button class="btn btn-disabled" disabled>
                            Pedido Enviado
                        </button>
                    {% elif friendship_status == 'request_received' %}
                        <div class="friend-request-actions">
                            <a href="{% url 'users:accept_friend_request' pending_request.id %}" class="btn btn-primary">
                                Aceitar
                            </a>
                            <a href="{% url 'users:reject_friend_request' pending_request.id %}" class="btn btn-secondary">
                                Recusar
                            </a>
                        </div>
                    {% else %}
                        <a href="{% url 'users:send_friend_request' user.username %}" class="btn btn-primary">
                            Adicionar Amigo
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <div class="profile-content">
            <div class="profile-sidebar">
                {% if user.profile.showStats %}
                    <section class="stats-card">
                        <h3 class="card-title">Estatísticas</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-number">{{ user.profile.animeCount }}</span>
                                <span class="stat-label">Animes</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">{{ user.profile.episodesWatched }}</span>
                                <span class="stat-label">Episódios</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-number">{{ friends_count }}</span>
                                <span class="stat-label">Amigos</span>
                            </div>
                        </div>
                    </section>
                {% endif %}

                {% if user.profile.bio %}
                    <section class="bio-card">
                        <h3 class="card-title">Sobre</h3>
                        <p class="bio-text">{{ user.profile.bio|linebreaks }}</p>
                    </section>
                {% endif %}

                {% if user.profile.website %}
                    <section class="links-card">
                        <h3 class="card-title">Links</h3>
                        <a href="{{ user.profile.website }}" target="_blank" rel="noopener" class="external-link">
                            Website pessoal
                        </a>
                    </section>
                {% endif %}
            </div>

            <div class="profile-main-content">
                <section class="friends-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            Amigos 
                            {% if friends_count %}
                                <span class="count">({{ friends_count }})</span>
                            {% endif %}
                        </h2>
                        {% if friends_count > 6 %}
                            <a href="{% url 'users:friends_list' user.username %}" class="view-all">Ver todos</a>
                        {% endif %}
                    </div>
                    
                    {% if friends %}
                        <div class="friends-grid">
                            {% for friend in friends %}
                                <div class="friend-card">
                                    <a href="{% url 'users:profile' friend.username %}" class="friend-link">
                                        <img src="{{ friend.profile.avatar.url }}" alt="{{ friend.username }}" class="friend-avatar">
                                        <span class="friend-name">{{ friend.username }}</span>
                                    </a>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <p class="empty-text">{{ user.username }} ainda não tem amigos adicionados.</p>
                        </div>
                    {% endif %}
                </section>

                <section class="activity-section">
                    <div class="section-header">
                        <h2 class="section-title">Lista de Animes</h2>
                        {% if request.user == user %}
                            <a href="{% url 'lists:user_list' user.username %}" class="view-all">Ver lista completa</a>
                        {% else %}
                            {% if user.profile.isPublic %}
                                <a href="{% url 'lists:user_list' user.username %}" class="view-all">Ver lista completa</a>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    {% if user.anime_entries.exists %}
                        <div class="anime-preview">
    {% for entry in user.anime_entries.all|slice:":6" %}
        <div class="anime-preview-item">
            <!-- Link envolvendo todo o card do anime -->
            <a href="{% url 'animes:detalhes_anime' entry.anime.mal_id %}" class="anime-card-link">
                <div class="anime-poster-small">
                    <img src="{{ entry.anime.image_url }}" alt="{{ entry.anime.title }}" loading="lazy">
                    {% if entry.score %}
                        <div class="anime-score-badge">{{ entry.score }}</div>
                    {% endif %}
                </div>
                <div class="anime-info-small">
                    <h4 class="anime-title-small">{{ entry.anime.title }}</h4>
                    <div class="anime-status">
                        <span class="status-badge status-{{ entry.status }}">
                            {% if entry.status == 'watching' %}Assistindo
                            {% elif entry.status == 'completed' %}Completo
                            {% elif entry.status == 'ptw' %}Planejo Assistir
                            {% endif %}
                        </span>
                    </div>
                    {% if entry.episodes_watched and entry.anime.episodes %}
                        <div class="progress-info">
                            {{ entry.episodes_watched }}/{{ entry.anime.episodes }} eps
                        </div>
                    {% endif %}
                </div>
            </a>
        </div>
    {% endfor %}
</div>
                        
                        {% if user.anime_entries.count > 6 %}
                            <div class="anime-preview-footer">
                                <p class="preview-count">
                                    Mostrando 6 de {{ user.anime_entries.count }} animes
                                </p>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-state">
                            {% if request.user == user %}
                                <p class="empty-text">Você ainda não adicionou nenhum anime à sua lista.</p>
                                <a href="{% url 'animes:buscar_anime' %}" class="btn btn-primary">Buscar Animes</a>
                            {% else %}
                                <p class="empty-text">{{ user.username }} ainda não tem animes na lista.</p>
                            {% endif %}
                        </div>
                    {% endif %}
                </section>
            </div>
        </div>
    </div>
</main>

<script src="{% static 'users/js/profile.js' %}"></script>
{% endblock %}

{% extends 'base.html' %}

{% block content %}
<div class="container detail">
    <div class="detail-header">
        {% if anime.images and anime.images.jpg.image_url %}
            <img src="{{ anime.images.jpg.image_url }}" alt="{{ anime.title }}" class="capa-lg">
        {% endif %}
        <div>
            <h1 class="page-title">{{ anime.title }}</h1>
            {% if anime.genres %}
                <div>
                    {% for genre in anime.genres %}
                        <span class="chips">{{ genre }}</span>
                    {% endfor %}
                </div>
            {% endif %}
            {% if anime.studios %}
                <p class="meta"><strong>Estúdios:</strong> {{ anime.studios|join:", " }}</p>
            {% endif %}
            {% if anime.episodes %}
                <p class="meta"><strong>Episódios:</strong> {{ anime.episodes }}</p>
            {% endif %}
            {% if anime.status %}
                <p class="meta"><strong>Status:</strong> {{ anime.status }}</p>
            {% endif %}
            {% if anime.score %}
                <p class="meta"><strong>Nota Média:</strong> {{ anime.score }}</p>
            {% endif %}
            {% if anime.rank %}
                <p class="meta"><strong>Rank:</strong> #{{ anime.rank }}</p>
            {% endif %}
            {% if anime.trailer and anime.trailer.url %}
                <p><a href="{{ anime.trailer.url }}" target="_blank" class="btn">Ver Trailer</a></p>
            {% endif %}
        </div>
    </div>

    {% if anime.synopsis %}
        <p class="sinopse">{{ anime.synopsis }}</p>
    {% endif %}

    <hr>

    <h2>Avaliações</h2>
    <ul class="lista-avaliacoes">
        {% if reviews %}
            {% for review in reviews %}
                <li class="card card-body">
                    <p><strong>{{ review.user.username }}</strong> - Nota: {{ review.score }}</p>
                    {% if review.comment %}
                        <p>{{ review.comment }}</p>
                    {% endif %}
                    <p class="meta">Em {{ review.created_at|date:"d/m/Y H:i" }}</p>
                </li>
            {% empty %}
                <li class="meta">Nenhuma avaliação ainda.</li>
            {% endfor %}
        {% else %}
            <li class="meta">Nenhuma avaliação ainda.</li>
        {% endif %}
    </ul>

    {% if user.is_authenticated %}
        {% with mal_id=anime.mal_id %}
            <form method="post" action="{% url 'avaliar_anime' mal_id %}" class="rate-form" style="margin-top:16px;">
                {% csrf_token %}

                <div class="nota-group">
                    <label for="score"><strong>Nota:</strong></label>
                    <select name="score" id="score" required>
                        {% for value, label in score_choices %}
                            <option value="{{ value }}" {% if user_review and user_review.score == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="comment"><strong>Comentário:</strong></label>
                    <textarea name="comment" id="comment" rows="4">{% if user_review %}{{ user_review.comment }}{% endif %}</textarea>
                </div>

                <button type="submit" class="btn">Enviar Avaliação</button>
            </form>
        {% endwith %}
    {% else %}
        <p class="meta">Você precisa <a href="{% url 'login_user' %}">entrar</a> para avaliar este anime.</p>
    {% endif %}
</div>
{% endblock %}

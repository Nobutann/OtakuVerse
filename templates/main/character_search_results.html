{% extends 'base.html' %}
{% block title %}Resultados para "{{ query }}"{% endblock %}
{% block content %}
<style>
    .search-results-container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
    .results-header { text-align: center; margin-bottom: 2.5rem; }
    .results-title { color: #fff; }
    .results-query { color: #ff79c6; }
    .results-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
    .char-card { background-color: #2a2a2e; border-radius: 10px; padding: 15px; width: 180px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,.4); transition: transform .2s ease-in-out; display: flex; flex-direction: column; justify-content: space-between; }
    .char-card:hover { transform: translateY(-8px); }
    .char-card img { width: 100%; height: 220px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; }
    .char-card h3 { font-size: 1rem; margin-bottom: 15px; color: #f8f8f2; min-height: 40px; flex-grow: 1; }
    .btn-add { background-color: #ff79c6; color: #fff; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; width: 100%; transition: background-color .2s; }
    .btn-add:hover { background-color: #e66ab2; }
    .no-results { text-align: center; color: #999; margin-top: 3rem; }
</style>
<main class="search-results-container">
    <header class="results-header">
        {% if query %}<h1 class="results-title">Resultados da busca por <span class="results-query">"{{ query }}"</span></h1>{% else %}<h1 class="results-title">Buscar Personagens</h1>{% endif %}
    </header>
    {% if characters %}
        <div class="results-grid">
            {% for char in characters %}
                <div class="char-card">
                    <img src="{{ char.images.jpg.image_url }}" alt="{{ char.name }}">
                    <h3>{{ char.name }}</h3>
                    {% if user.is_authenticated %}
                        <button class="btn-add" onclick="addFavorite('{{ char.mal_id }}', '{{ char.name|escapejs }}', '{{ char.images.jpg.image_url }}')">
                            Adicionar aos Favoritos ⭐
                        </button>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-results">Nenhum personagem encontrado para "{{ query }}".</p>
    {% endif %}
</main>
{% endblock %}

{% block scripts %}
{% if user.is_authenticated %}
<script>
    const csrfToken = '{{ csrf_token }}';
    async function addFavorite(id, name, imageUrl) {
        try {
            const response = await fetch("{% url 'lists:add_favorite_character' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ id: id, name: name, image: imageUrl })
            });
            // CORREÇÃO: Adicionamos verificação se a resposta do servidor foi bem-sucedida
            if (!response.ok) {
                throw new Error(`Erro do servidor: ${response.statusText}`);
            }
            const result = await response.json();
            if (result.status === 'success') {
                alert(`'${name}' foi adicionado aos seus favoritos!`);
            } else {
                alert(result.message);
            }
        } catch (error) {
            console.error('Ocorreu um erro ao adicionar o favorito:', error);
            alert('Não foi possível adicionar o favorito. Verifique o console para mais detalhes.');
        }
    }
</script>
{% endif %}
{% endblock scripts %}